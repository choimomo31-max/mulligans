<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë©€ë¦¬ê±´ì¦ˆ ëŒ€íšŒ ìˆœìœ„í‘œ</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    padding: 10px;
}
h1, h2 { text-align: center; }
table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    margin-bottom: 20px;
    font-size: 14px;
}
th, td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: center;
}
th {
    background: #2c3e50;
    color: white;
}
input, select {
    width: 60px;
    padding: 4px;
    text-align: center;
}
button {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    font-size: 16px;
    background: #3498db;
    color: white;
    border: none;
    cursor: pointer;
}
input {
    font-size: 16px; /* iOS ìë™ í™•ëŒ€ ë°©ì§€ */
}
.button-area {
    display: flex;
    gap: 8px;
    margin: 10px 0;
}
.button-area button {
    flex: 1;
}
.rank-1 { background: #fff3cd; font-weight: bold; }
.rank-2 { background: #f1f1f1; }
.rank-3 { background: #fdf2e9; }

.ocr-box {
    background: white;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 15px;
}
textarea {
    width: 100%;
    height: 120px;
    padding: 10px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 6px;
    resize: vertical;
}
.ocr-btns {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}
.ocr-btns button {
    flex: 1;
    background: #27ae60;
}
.ocr-btns button.reset {
    background: #e74c3c;
}
.small-hint {
    font-size: 12px;
    color: #555;
    margin-top: 6px;
}

@media (max-width:600px) {
    table { font-size: 12px; }
    input { width: 40px; }
    select { width: 40px; }
}
</style>
</head>
<body>

<h1>ğŸŒï¸ ë©€ë¦¬ê±´ì¦ˆ ëŒ€íšŒ ìˆœìœ„í‘œ</h1>

<div class="ocr-box">
    <h2 style="margin:0; font-size:16px;">ğŸ“¸ ìŠ¤ì½”ì–´ì¹´ë“œ OCR (ì‚¬ì§„ì´¬ì˜ ì§€ì›)</h2>
    <textarea id="ocrInput" placeholder="ì˜ˆì‹œ:
ìƒë¬´í˜•ë‹˜ì¡ì 84(+12) +12.3
êµ¿ìƒ·ë¬´ë˜ 66(-6) -4.8
ë´„ë‚ ì•¤ì‹±ê¸€ 85(+13) -2.2"></textarea>

    <div class="ocr-btns">
        <button onclick="runCameraOCR()">ğŸ“¸ ì‚¬ì§„ì´¬ì˜ OCR ì‹¤í–‰</button>
        <button onclick="applyOCR()">âœ… OCR í…ìŠ¤íŠ¸ ìë™ ì…ë ¥</button>
        <button class="reset" onclick="clearOCR()">ğŸ§¹ OCRì°½ ë¹„ìš°ê¸°</button>
    </div>

    <div class="small-hint">
        âœ”ï¸ ìë™ìœ¼ë¡œ íšŒì›ëª… ë§¤ì¹­ í›„<br>
        - Gí•¸ë”” â†’ í•¸ë”” ì¹¸ ì…ë ¥<br>
        - Total ê´„í˜¸ê°’ â†’ ìŠ¤ì½”ì–´ ì¹¸ ì…ë ¥<br>
        (ì´í›„ ìˆœìœ„ ê³„ì‚° ë²„íŠ¼ ëˆ„ë¥´ë©´ Net ìë™ ë°˜ì˜ë¨)
    </div>
</div>

<div class="button-area">
    <button onclick="resetRound()">ğŸ”„ ëŒ€íšŒ ì´ˆê¸°í™”</button>
    <button onclick="calculate()">ğŸ“Š ìˆœìœ„ ê³„ì‚°</button>
</div>

<table id="playerTable">
<thead>
<tr>
    <th>ìˆœìœ„</th>
    <th>íšŒì›ëª…</th>
    <th>íŒ€</th>
    <th>Gí•¸ë””</th>
    <th>ìŠ¤ì½”ì–´</th>
    <th>ë©€ë¦¬ê±´</th>
    <th>Net</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h2>ğŸ† íŒ€ ìˆœìœ„</h2>
<table id="teamTable">
<thead>
<tr>
    <th>ìˆœìœ„</th>
    <th>íŒ€</th>
    <th>íŒ€ Net í•©ê³„</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
const members = [
"ê³½ì •í›ˆ","ê¹€ê¸°íƒœ","êµ¿ìƒ·ë¬´ë˜","ê¹€ì¬ìš±","ê¹€ì¤€ìš°","ìƒë¬´í˜•ë‹˜ì¡ì","ê¹€íŒêµ","ëª…ë…¸ìš±",
"ë°•ìƒìš©","ë°•ìš°ë¯¼","ë°•ì² ìˆ˜","ì„œì„±í•˜","ì†¡í˜¸ì¤€","ì˜¤ì°¬ìš±","ì´ì •ì€","ì´ì¤€ì˜",
"ì „ì§„ìš©","ë´„ë‚ ì•¤ì‹±ê¸€","ìµœì˜ì§„","í™©ë„ì˜"];

const storageKey = "golfzonTournamentData";

// ì´ˆê¸° í…Œì´ë¸” ìƒì„±
const tbody = document.querySelector("#playerTable tbody");
members.forEach((name, i) => {
    tbody.insertAdjacentHTML("beforeend", `
    <tr data-index="${i}">
        <td>-</td>
        <td class="playerName">${name}</td>
        <td>
            <select>
                <option></option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option>
            </select>
        </td>
        <td><input class="handicap" type="text" inputmode="numeric" pattern="-?[0-9]*"></td>
        <td><input class="score" type="text" inputmode="numeric" pattern="-?[0-9]*"></td>
        <td><input class="mulligan" type="text" inputmode="numeric" pattern="-?[0-9]*"></td>
        <td>-</td>
    </tr>
    `);
});

// ì €ì¥ ë¡œë“œ
loadData();

// ìë™ ì €ì¥ ì´ë²¤íŠ¸
document.querySelectorAll("input, select").forEach(el => {
    el.addEventListener("input", saveData);
});

function resetRound() {
    const ok = confirm("íŒ€, ìŠ¤ì½”ì–´, ë©€ë¦¬ê±´, Netì„ ì´ˆê¸°í™”í• ê¹Œìš”?\n(í•¸ë””ì™€ íšŒì›ëª…ì€ ìœ ì§€ë©ë‹ˆë‹¤)");

    if (!ok) return;

    const rows = [...tbody.rows];

    rows.forEach(r => {
        r.querySelector("select").value = "";

        const inputs = r.querySelectorAll("input");

        // ìŠ¤ì½”ì–´ ì´ˆê¸°í™”
        inputs[1].value = "";

        // ë©€ë¦¬ê±´ ì´ˆê¸°í™”
        inputs[2].value = "";

        // ìˆœìœ„ / Net ì´ˆê¸°í™”
        r.cells[0].textContent = "-";
        r.cells[6].textContent = "-";

        // ìŠ¤íƒ€ì¼ ì œê±°
        r.className = "";
    });

    document.querySelector("#teamTable tbody").innerHTML = "";
    saveData();
}

function saveData() {
    const data = [...tbody.rows].map(r => {
        const inputs = r.querySelectorAll("input");
        return {
            team: r.querySelector("select").value,
            handicap: inputs[0].value,
            score: inputs[1].value,
            mulligan: inputs[2].value
        };
    });
    localStorage.setItem(storageKey, JSON.stringify(data));
}

function loadData() {
    const data = JSON.parse(localStorage.getItem(storageKey) || "[]");
    data.forEach((d, i) => {
        const row = tbody.rows[i];
        if (!row) return;
        row.querySelector("select").value = d.team || "";
        const inputs = row.querySelectorAll("input");
        inputs[0].value = d.handicap || "";
        inputs[1].value = d.score || "";
        inputs[2].value = d.mulligan || "";
    });
}

// OCR ì…ë ¥ì°½ ë¹„ìš°ê¸°

function setProgress(pct) {
    pct = Math.max(0, Math.min(100, pct));
    const t = document.getElementById("progressText");
    const f = document.getElementById("progressFill");
    if (t) t.textContent = pct + "%";
    if (f) f.style.width = pct + "%";
}

// ì¹´ë©”ë¼ ì´¬ì˜/ì—…ë¡œë“œ ì´ë¯¸ì§€ OCR ì‹¤í–‰
async function runCameraOCR() {
    const input = document.getElementById("cameraInput");
    if (!input || !input.files || input.files.length === 0) {
        alert("ë¨¼ì € ìŠ¤ì½”ì–´ì¹´ë“œ ì‚¬ì§„ì„ ì´¬ì˜(ë˜ëŠ” ì„ íƒ)í•´ì£¼ì„¸ìš”!");
        return;
    }

    const file = input.files[0];
    setProgress(0);

    const ocrBox = document.getElementById("ocrInput");
    if (ocrBox) ocrBox.value = "OCR ì‹¤í–‰ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";

    try {
        const result = await Tesseract.recognize(
            file,
            "kor+eng",
            {
                logger: m => {
                    if (m.status === "recognizing text") {
                        const pct = Math.floor((m.progress || 0) * 100);
                        setProgress(pct);
                    }
                }
            }
        );

        setProgress(100);
        if (ocrBox) ocrBox.value = result.data.text;

        // OCR ëë‚˜ë©´ ìë™ìœ¼ë¡œ applyOCR ì‹¤í–‰
        applyOCR();

        alert("âœ… OCR ì™„ë£Œ + ìë™ ì…ë ¥ ì™„ë£Œ!");

    } catch (err) {
        console.error(err);
        alert("âŒ OCR ì‹¤íŒ¨! (ë¸Œë¼ìš°ì € ì½˜ì†” í™•ì¸)");
        if (ocrBox) ocrBox.value = "";
        setProgress(0);
    }
}

function clearOCR() {
    document.getElementById("ocrInput").value = "";
}

// OCR í…ìŠ¤íŠ¸ íŒŒì‹± í›„ ìë™ ì…ë ¥
function applyOCR() {
    const text = document.getElementById("ocrInput").value.trim();

    if (!text) {
        alert("OCR í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”!");
        return;
    }

    const lines = text.split("\n").map(l => l.trim()).filter(Boolean);

    let updatedCount = 0;
    let notFoundNames = [];

    lines.forEach(line => {
        // ì˜ˆì‹œ: ìƒë¬´í˜•ë‹˜ì¡ì 84(+12) +12.3
        // ê´„í˜¸ê°’ ì¶”ì¶œ (+12, -6 ë“±)
        const bracketMatch = line.match(/\(([+-]?\d+)\)/);
        const bracketValue = bracketMatch ? bracketMatch[1] : null;

        // Gí•¸ë”” ì¶”ì¶œ (+12.3, -4.8 ë“±)
        const gHandyMatch = line.match(/([+-]?\d+\.\d+)/);
        const gHandyValue = gHandyMatch ? gHandyMatch[1] : null;

        // ì´ë¦„ì€ members ëª©ë¡ ì¤‘ í¬í•¨ë˜ëŠ” ë¬¸ìì—´ë¡œ ì°¾ê¸°
        const foundName = members.find(n => line.includes(n));

        if (!foundName) {
            notFoundNames.push(line);
            return;
        }

        // í…Œì´ë¸”ì—ì„œ í•´ë‹¹ row ì°¾ê¸°
        const row = [...tbody.rows].find(r => r.querySelector(".playerName").textContent === foundName);
        if (!row) return;

        // í•¸ë””(Gí•¸ë””) ì…ë ¥
        if (gHandyValue !== null) {
            row.querySelector(".handicap").value = gHandyValue;
        }

        // ìŠ¤ì½”ì–´ ì¹¸ì— ê´„í˜¸ê°’ ì…ë ¥
        if (bracketValue !== null) {
            row.querySelector(".score").value = bracketValue;
        }

        updatedCount++;
    });

    saveData();

    let msg = `âœ… OCR ìë™ ì…ë ¥ ì™„ë£Œ!\n\nì´ ${updatedCount}ëª… ë°˜ì˜ë¨`;

    if (notFoundNames.length > 0) {
        msg += `\n\nâš ï¸ ì´ë¦„ ë§¤ì¹­ ì‹¤íŒ¨í•œ ì¤„:\n${notFoundNames.join("\n")}`;
    }

    alert(msg);
}

function calculate() {
    const rows = [...tbody.rows];
    const validPlayers = [];

    rows.forEach(r => {
        r.className = "";
        r.cells[0].textContent = "-";
        r.cells[6].textContent = "-";

        const inputs = r.querySelectorAll("input");
        const score = Number(inputs[1].value);

        // ìŠ¤ì½”ì–´ ì—†ìœ¼ë©´ ì œì™¸
        if (!score) return;

        const handicap = Number(inputs[0].value || 0);
        const mulligan = Number(inputs[2].value || 0);

        const net = score - handicap - mulligan;

        validPlayers.push({
            row: r,
            team: r.querySelector("select").value,
            net,
            handicap
        });
    });

    validPlayers.sort((a, b) => {
        if (a.net !== b.net) {
            return a.net - b.net;        // 1ìˆœìœ„: Net
        }
        return a.handicap - b.handicap; // 2ìˆœìœ„: í•¸ë”” (ì‘ì„ìˆ˜ë¡ ìƒìœ„)
    });

    validPlayers.forEach((p, i) => {
        let rankText = i + 1;
        if (i === 0) rankText = "ğŸ¥‡";
        if (i === 1) rankText = "ğŸ¥ˆ";
        if (i === 2) rankText = "ğŸ¥‰";

        p.row.cells[0].innerHTML = rankText;
		p.row.cells[6].textContent = p.net.toFixed(1);

        if (i === 0) p.row.classList.add("rank-1");
        if (i === 1) p.row.classList.add("rank-2");
        if (i === 2) p.row.classList.add("rank-3");
    });

    // íŒ€ ìˆœìœ„ ê³„ì‚°
    const teamMap = {};
    validPlayers.forEach(p => {
        const team = p.team || "ë¯¸ì§€ì •";
        teamMap[team] = (teamMap[team] || 0) + p.net;
    });

    const teamBody = document.querySelector("#teamTable tbody");
    teamBody.innerHTML = Object.entries(teamMap)
        .sort((a,b)=>a[1]-b[1])
        .map((t,i)=>`
            <tr>
                <td>${i+1}</td>
                <td>${t[0]}</td>
				<td>${Number(t[1]).toFixed(1)}</td>
            </tr>
        `).join("");
}
</script>

</body>
</html>
